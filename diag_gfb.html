<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Diagnostic Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            transition: background-color 0.3s ease;
        }
        .pending { background-color: #f59e0b; }
        .success { background-color: #22c55e; }
        .error { background-color: #ef4444; }
        .log-entry {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        .log-info { border-color: #3b82f6; }
        .log-success { border-color: #22c55e; }
        .log-error { border-color: #ef4444; }
        .log-warn { border-color: #f59e0b; }
        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-6 lg:p-8">
    <div class="max-w-4xl mx-auto bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">
        <header class="bg-gray-700 p-6 border-b border-gray-600">
            <h1 class="text-2xl font-bold text-white">Firebase & App Health Diagnostic Tool</h1>
            <p class="text-gray-400 mt-1">Real-time analysis of your 'Trivia Peek' application status.</p>
        </header>

        <main class="p-6 space-y-6">
            <!-- Firebase Configuration Section -->
            <div>
                <h2 class="text-xl font-semibold mb-3">1. Firebase Configuration</h2>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <p class="text-gray-300 mb-4">Enter your Firebase config object below to test initialization.</p>
                    <textarea id="firebaseConfigInput" class="w-full h-48 bg-gray-900 text-gray-200 p-3 rounded-md font-mono text-sm border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Paste your firebaseConfig object here..."></textarea>
                    <button id="runDiagnosticBtn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                        <span>Run Full Diagnostic</span>
                    </button>
                </div>
            </div>

            <!-- Diagnostic Report Section -->
            <div id="reportSection" class="hidden">
                <h2 class="text-xl font-semibold mb-4">2. Diagnostic Report</h2>
                <div class="space-y-4">
                    <!-- Firebase Initialization -->
                    <div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                        <span class="font-medium">Firebase Initialization</span>
                        <div class="flex items-center space-x-2">
                            <span id="firebaseStatusText" class="text-gray-400 text-sm">Pending...</span>
                            <div id="firebaseStatus" class="status-dot pending"></div>
                        </div>
                    </div>
                    <!-- Database Connection -->
                    <div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                        <span class="font-medium">Database Connection</span>
                        <div class="flex items-center space-x-2">
                            <span id="dbStatusText" class="text-gray-400 text-sm">Pending...</span>
                            <div id="dbStatus" class="status-dot pending"></div>
                        </div>
                    </div>
                    <!-- Data Fetch Test -->
                    <div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                        <span class="font-medium">Question Data Fetch</span>
                        <div class="flex items-center space-x-2">
                            <span id="fetchStatusText" class="text-gray-400 text-sm">Pending...</span>
                            <div id="fetchStatus" class="status-dot pending"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Log Stream -->
            <div id="logSection" class="hidden">
                <h2 class="text-xl font-semibold mb-4">3. Live Log Stream</h2>
                <div id="logContainer" class="bg-gray-900 p-4 rounded-lg h-80 overflow-y-auto font-mono text-sm space-y-2">
                    <!-- Log entries will be added here -->
                    <div class="flex justify-center items-center h-full text-gray-500">
                        <p>Awaiting diagnostic start...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Firebase SDK (IMPORTANT: Using version 9.6.10 as seen in your PDF)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

        const firebaseConfigInput = document.getElementById('firebaseConfigInput');
        const runDiagnosticBtn = document.getElementById('runDiagnosticBtn');
        const reportSection = document.getElementById('reportSection');
        const logSection = document.getElementById('logSection');
        const logContainer = document.getElementById('logContainer');

        const firebaseStatus = document.getElementById('firebaseStatus');
        const firebaseStatusText = document.getElementById('firebaseStatusText');
        const dbStatus = document.getElementById('dbStatus');
        const dbStatusText = document.getElementById('dbStatusText');
        const fetchStatus = document.getElementById('fetchStatus');
        const fetchStatusText = document.getElementById('fetchStatusText');

        // --- Logging Utility ---
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            entry.className = `log-entry p-2 rounded-md bg-gray-800 log-${type}`;
            entry.innerHTML = `<span class="font-bold text-gray-500 mr-2">[${timestamp}]</span><span>${message}</span>`;
            
            // If it's the first log, clear the placeholder
            if (logContainer.querySelector('p')) {
                logContainer.innerHTML = '';
            }

            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight; // Auto-scroll to bottom
        }

        // --- UI Update Utilities ---
        function updateStatus(element, textElement, status, text) {
            element.className = `status-dot ${status}`;
            textElement.textContent = text;
        }
        
        function resetUI() {
            reportSection.classList.add('hidden');
            logSection.classList.add('hidden');
            logContainer.innerHTML = '<div class="flex justify-center items-center h-full text-gray-500"><p>Awaiting diagnostic start...</p></div>';

            updateStatus(firebaseStatus, firebaseStatusText, 'pending', 'Pending...');
            updateStatus(dbStatus, dbStatusText, 'pending', 'Pending...');
            updateStatus(fetchStatus, fetchStatusText, 'pending', 'Pending...');
        }

        runDiagnosticBtn.addEventListener('click', async () => {
            resetUI();
            reportSection.classList.remove('hidden');
            logSection.classList.remove('hidden');
            log('Diagnostic sequence initiated.', 'info');

            let firebaseConfig;
            let app;
            let db;

            // --- Step 1: Parse Configuration ---
            try {
                // A safer way to parse the config to avoid eval()
                const configStr = firebaseConfigInput.value.replace(/(\w+):/g, '"$1":');
                firebaseConfig = JSON.parse(configStr);
                log('Firebase configuration parsed successfully.', 'success');
            } catch (error) {
                log(`FATAL: Could not parse Firebase configuration. Check for syntax errors (e.g., missing commas, incorrect quotes). Details: ${error.message}`, 'error');
                updateStatus(firebaseStatus, firebaseStatusText, 'error', 'Config Error');
                return;
            }
             if (!firebaseConfig.apiKey || !firebaseConfig.databaseURL) {
                log('FATAL: Configuration object is missing required keys like "apiKey" or "databaseURL".', 'error');
                updateStatus(firebaseStatus, firebaseStatusText, 'error', 'Invalid Config');
                return;
            }


            // --- Step 2: Initialize Firebase ---
            try {
                log('Attempting to initialize Firebase app...', 'info');
                app = initializeApp(firebaseConfig);
                updateStatus(firebaseStatus, firebaseStatusText, 'success', 'Initialized');
                log('Firebase app initialized successfully.', 'success');
            } catch (error) {
                log(`FATAL: Firebase initialization failed. This often happens with an invalid config. Details: ${error.message}`, 'error');
                updateStatus(firebaseStatus, firebaseStatusText, 'error', 'Init Failed');
                return;
            }

            // --- Step 3: Get Database and Test Connection ---
            try {
                log('Attempting to connect to the Realtime Database...', 'info');
                db = getDatabase(app);
                // A simple read at the root is a good connection test.
                await get(ref(db, '.info/connected'));
                updateStatus(dbStatus, dbStatusText, 'success', 'Connected');
                log('Successfully connected to the Realtime Database.', 'success');
            } catch (error) {
                log(`ERROR: Could not connect to the database. Check databaseURL and security rules. Details: ${error.message}`, 'error');
                updateStatus(dbStatus, dbStatusText, 'error', 'Connection Failed');
                // We can still try to fetch, but it will likely fail.
            }

            // --- Step 4: Test Fetching Question Data ---
            if (db) {
                try {
                    log("Attempting to fetch a sample question from 'questions/action/0'...", 'info');
                    // Based on your chronicle, the data is under a `questions` node.
                    // We'll try to fetch the first question from the 'action' category.
                    const questionRef = ref(db, 'questions/action/0'); 
                    const snapshot = await get(questionRef);

                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        updateStatus(fetchStatus, fetchStatusText, 'success', 'Fetch OK');
                        log('Successfully fetched sample question data.', 'success');
                        log(`Data received: ${JSON.stringify(data)}`, 'info');
                    } else {
                        updateStatus(fetchStatus, fetchStatusText, 'error', 'Not Found');
                        log("ERROR: Could not find data at path 'questions/action/0'. Check your Firebase data structure. The root should have a 'questions' key, which has genre keys like 'action', which holds an array of question objects.", 'error');
                    }
                } catch (error) {
                    updateStatus(fetchStatus, fetchStatusText, 'error', 'Fetch Failed');
                    log(`ERROR: Failed to fetch question data. This is likely a security rules issue. Ensure your database rules allow read access. Details: ${error.message}`, 'error');
                }
            } else {
                 updateStatus(fetchStatus, fetchStatusText, 'error', 'Skipped');
                 log('SKIPPED: Cannot test data fetch without a valid database connection.', 'warn');
            }
            
            log('Diagnostic sequence complete.', 'info');
        });

    </script>
</body>
</html>
